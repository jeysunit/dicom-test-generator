# ADR-0004: UUID 2.25 UID

## Status

**Accepted** - 2025-02-21

## Context

DICOM UIDの生成方式を決定する必要がある。

### 要求

- グローバルに一意なUIDが必要
- DICOM Standard準拠
- 簡単に実装可能

### 選択肢

1. **UUID 2.25方式**: `2.25.{UUID整数値}`
2. **組織OID方式**: IHE Japanから組織OIDを取得し、`1.2.392.xxx.{枝番}`
3. **ハードコードUID**: 固定UID + 連番

### 現状

- 組織OIDを持っていない
- 個人開発プロジェクト
- テストデータ生成が目的

## Decision

デフォルトでUUID 2.25方式を採用する。

ただし、将来的に組織OIDを取得した場合に切り替え可能な設計とする。

### 実装方針

```python
class UIDGenerator:
    def __init__(
        self,
        method: Literal["uuid_2_25", "custom_root"] = "uuid_2_25",
        custom_root: str = ""
    ):
        self.method = method
        self.custom_root = custom_root
        self.counter = 1
    
    def generate_study_uid(self) -> str:
        if self.method == "uuid_2_25":
            return f"2.25.{uuid.uuid4().int}"
        elif self.method == "custom_root":
            uid = f"{self.custom_root}.{self.counter}"
            self.counter += 1
            return uid
```

### 設定ファイル

```yaml
# config.yaml
uid:
  method: "uuid_2_25"  # デフォルト
  custom_root: ""
```

組織OID取得後：

```yaml
uid:
  method: "custom_root"
  custom_root: "1.2.392.200036.9999"
```

## Consequences

### Positive

- ✅ 組織OID不要で即座に開発開始可能
- ✅ グローバルに一意性が保証される
- ✅ DICOM Standard準拠（RFC 3061）
- ✅ 実装が簡単（uuid.uuid4()のみ）
- ✅ 衝突リスクがほぼゼロ

### Negative

- ⚠️ UIDが長い（約40文字）
  - 例: `2.25.113059749145936325402354257176981405696`
  - **影響**: DICOMビューアでは問題なし、表示が若干長い程度

### Risks & Mitigations

- ⚠️ **将来的にカスタムRootに切り替えた場合、過去データとの互換性がない**
  - 軽減策: Study Instance UIDが変わるため、別スタディとして扱われる（問題なし）
- ⚠️ **連番カウンタの管理が必要（カスタムRoot使用時）**
  - 軽減策: Phase 1で永続化機能を追加

### Tradeoffs

- UUID 2.25: 長いが実装簡単、組織OID不要
- カスタムRoot: 短く読みやすいが、組織OID取得が必要

## Implementation

### Phase 0

- UUID 2.25方式のみ実装
- カスタムRoot対応は設計のみ

### Phase 1以降

- カスタムRoot方式を実装
- 連番カウンタの永続化

## Related Decisions

- [ADR-0001: Core Library First](0001-core-library-first.md)

## References

- DICOM Standard Part 5: Data Structures and Encoding
- RFC 3061: A URN Namespace of Object Identifiers
- IHE Japan OID取得: <https://www.ihe-j.org/>
- [05_uid_generation.md](../spec/06_dicom_rules.md#uid生成)
